<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>M3U Oynatıcı</title>
<link href="https://vjs.zencdn.net/8.12.0/video-js.css" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --bgd: #121212;
  --bgm: #1e1e1e;
  --bgl: #2a2a2a;
  --tc: #e0e0e0;
  --ac: #007bff;
  --ah: #0056b3;
  --fo: #00aaff;
  --bc: #333;
  --sc: rgba(0,0,0,.5);
}

body {
  font-family: 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  background-color: var(--bgd);
  color: var(--tc);
  display: flex;
  min-height: 100vh;
  margin: 0;
  overflow: hidden;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

.main-container {
  display: flex;
  flex-direction: column;
  width: 100%;
  max-width: 1400px;
  margin: 20px auto;
  background-color: var(--bgm);
  border-radius: 12px;
  box-shadow: 0 8px 30px var(--sc);
  overflow: hidden;
}

.content-area {
  display: flex;
  flex-grow: 1;
}

.category-panel {
  width: 280px;
  background-color: var(--bgd);
  padding: 20px 0;
  overflow-y: auto;
  border-right: 1px solid var(--bc);
  flex-shrink: 0;
}

.category-panel h3 {
  text-align: center;
  margin-bottom: 20px;
  color: #fff;
  font-size: 1.5em;
  letter-spacing: .5px;
}

.category-panel input[type="text"] {
  width: calc(100% - 40px);
  margin: 0 20px 20px;
  padding: 10px 15px;
  border-radius: 8px;
  border: 1px solid var(--bc);
  background-color: #333;
  color: var(--tc);
  box-sizing: border-box;
  font-size: .95em;
  transition: all .3s ease;
}

.category-panel input[type="text"].focused,
.category-panel input[type="text"]:focus {
  outline: 3px solid var(--fo);
  border-color: var(--fo);
  box-shadow: 0 0 0 4px rgba(0,170,255,.2);
}

.category-panel ul {
  list-style: none;
  padding: 0;
  margin: 0;
}

.category-panel li {
  padding: 14px 25px;
  cursor: pointer;
  transition: background-color .3s ease, border-left-color .3s ease;
  border-left: 5px solid transparent;
  font-size: 1.05em;
  position: relative;
}

.category-panel li:hover {
  background-color: #333;
}

.category-panel li.active {
  background-color: var(--ac);
  border-left-color: var(--fo);
  font-weight: 700;
  color: #fff;
}

.category-panel li.active::after {
  content: '►';
  position: absolute;
  right: 15px;
  color: #fff;
  font-size: .9em;
}

.category-panel li.focused {
  outline: 3px solid var(--fo);
  background-color: #444;
  outline-offset: -2px;
}

.player-list-area {
  flex-grow: 1;
  display: flex;
  flex-direction: column;
  background-color: var(--bgl);
}

.player-wrapper {
  width: 100%;
  position: relative;
  background-color: #000;
  border-bottom: 1px solid var(--bc);
}

.video-js {
  width: 100% !important;
  height: auto !important;
  min-height: 350px;
}

.vjs-control-bar {
  background-color: rgba(0,0,0,.8);
  border-radius: 0 0 12px 12px;
}

.vjs-button > .vjs-icon-placeholder:before {
  font-size: 1.8em;
  color: var(--tc);
}

.vjs-menu-button-popup .vjs-menu {
  background-color: rgba(42,42,42,.95);
  border-radius: 8px;
  box-shadow: 0 4px 15px rgba(0,0,0,.4);
}

.vjs-menu-item {
  color: var(--tc);
  padding: 8px 15px;
  transition: background-color .2s ease;
}

.vjs-menu-item:focus,
.vjs-menu-item:hover {
  background-color: #3a3a3a;
  color: #fff;
}

.vjs-current-time,
.vjs-duration {
  color: var(--tc);
}

.video-js.vjs-waiting .vjs-loading-spinner {
  border-color: var(--tc);
  border-top-color: var(--ac);
}

.channel-list-wrapper {
  padding: 20px;
  overflow-y: auto;
  flex-grow: 1;
  outline: none;
  min-height: 0;
  background-color: var(--bgl);
}

.channel-list-wrapper input[type=text] {
  width: calc(100% - 40px);
  padding: 10px 15px;
  margin-bottom: 20px;
  border-radius: 8px;
  border: 1px solid var(--bc);
  background-color: #333;
  color: var(--tc);
  box-sizing: border-box;
  font-size: .95em;
  transition: all .3s ease;
}

.channel-list-wrapper input[type=text].focused,
.channel-list-wrapper input[type=text]:focus {
  outline: 3px solid var(--fo);
  border-color: var(--fo);
  box-shadow: 0 0 0 4px rgba(0,170,255,.2);
}

.channel-list {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 20px;
}

.channel-item {
  background-color: #333;
  border-radius: 10px;
  overflow: hidden;
  cursor: pointer;
  transition: transform .2s ease, box-shadow .2s ease, outline-color .2s ease, background-color .2s ease;
  text-align: center;
  padding: 15px;
  outline: 2px solid transparent;
  position: relative;
}

.channel-item:hover {
  transform: translateY(-5px);
  box-shadow: 0 8px 20px rgba(0,0,0,.4);
  background-color: #3a3a3a;
}

.channel-item img {
  max-width: 90px;
  height: auto;
  margin-bottom: 12px;
  border-radius: 8px;
  object-fit: contain;
}

.channel-item .channel-name {
  font-weight: 600;
  color: var(--tc);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  font-size: 1.1em;
  padding: 0 5px;
}

.channel-item.focused {
  outline: 3px solid var(--fo);
  background-color: #444;
  box-shadow: 0 8px 20px rgba(0,0,0,.4);
}

.resume-prompt {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0,0,0,.9);
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  z-index: 100;
  font-size: 1.4em;
  text-align: center;
  color: #fff;
  padding: 20px;
  box-sizing: border-box;
}

.resume-prompt p {
  margin-bottom: 25px;
  line-height: 1.5;
  font-weight: 500;
}

.resume-prompt button {
  background-color: var(--ac);
  color: #fff;
  border: none;
  padding: 12px 25px;
  border-radius: 8px;
  cursor: pointer;
  margin: 0 10px;
  font-size: 1.1em;
  transition: background-color .3s ease, outline .2s ease, transform .2s ease;
}

.resume-prompt button:hover {
  background-color: var(--ah);
  transform: translateY(-2px);
}

.resume-prompt button.focused {
  outline: 3px solid var(--fo);
  background-color: var(--ah);
  outline-offset: 3px;
}

.loading-screen {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0,0,0,.95);
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  z-index: 1000;
  color: #fff;
  font-size: 1.8em;
  opacity: 1;
  visibility: visible;
  transition: opacity .4s ease, visibility .4s ease;
}

.loading-screen.hidden {
  opacity: 0;
  visibility: hidden;
  pointer-events: none;
}

.loading-spinner {
  border: 6px solid rgba(255,255,255,.3);
  border-top: 6px solid var(--ac);
  border-radius: 50%;
  width: 60px;
  height: 60px;
  animation: spin 1s linear infinite;
  margin-bottom: 25px;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.error-message {
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  background-color: #dc3545;
  color: #fff;
  padding: 12px 25px;
  border-radius: 8px;
  z-index: 1000;
  opacity: 0;
  visibility: hidden;
  transition: opacity .4s ease, visibility .4s ease;
  box-shadow: 0 4px 15px rgba(0,0,0,.3);
}

.error-message.show {
  opacity: 1;
  visibility: visible;
}

/* Yeni Kontrol Paneli Stilleri */
.control-panel {
  position: fixed;
  bottom: 20px;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(30, 30, 30, 0.9);
  border-radius: 20px;
  padding: 15px;
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 10px;
  z-index: 999;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
  backdrop-filter: blur(10px);
  transition: all 0.3s ease;
  opacity: 0.9;
}

.control-panel:hover {
  opacity: 1;
}

.control-row {
  display: flex;
  justify-content: center;
  gap: 10px;
}

.control-btn {
  width: 60px;
  height: 60px;
  border-radius: 15px;
  background: var(--bgm);
  border: 2px solid var(--bc);
  color: var(--tc);
  font-size: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.2s ease;
  position: relative;
  user-select: none;
}

.control-btn:active {
  transform: scale(0.95);
  background: var(--ac);
}

.control-btn:hover {
  border-color: var(--fo);
  box-shadow: 0 0 15px var(--fo);
}

.control-btn::after {
  content: attr(data-key);
  position: absolute;
  bottom: -25px;
  font-size: 12px;
  color: var(--tc);
  opacity: 0.7;
}

.center-btn {
  width: 80px;
  height: 80px;
  font-size: 30px;
}

.volume-control {
  position: absolute;
  bottom: 100%;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(30, 30, 30, 0.9);
  padding: 10px;
  border-radius: 10px;
  margin-bottom: 10px;
  display: none;
}

.control-btn.active {
  background: var(--ac);
  color: white;
  transform: scale(0.95);
}

.gamepad-notification {
  position: fixed;
  bottom: 120px;
  left: 50%;
  transform: translateX(-50%);
  background: var(--ac);
  color: white;
  padding: 10px 20px;
  border-radius: 10px;
  z-index: 1000;
  opacity: 0;
  transition: opacity 0.3s ease;
  pointer-events: none;
}

.gamepad-notification.show {
  opacity: 1;
}

@media (max-width: 1024px) {
  .main-container {
    max-width: 95%;
    margin: 15px auto;
  }
  .category-panel {
    width: 220px;
    padding: 15px 0;
  }
  .video-js {
    min-height: 280px;
  }
  .channel-list {
    grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
    gap: 15px;
  }
  .channel-item img {
    max-width: 70px;
  }
}

@media (max-width: 768px) {
  body {
    overflow-y: auto;
  }
  .main-container {
    flex-direction: column;
    margin: 10px auto;
    height: auto;
    min-height: unset;
    border-radius: 0;
  }
  .content-area {
    flex-direction: column;
    min-height: unset;
  }
  .category-panel {
    width: 100%;
    border-right: none;
    border-bottom: 1px solid var(--bc);
    padding: 10px;
    max-height: 180px;
  }
  .category-panel h3 {
    display: none;
  }
  .category-panel input[type="text"] {
    width: calc(100% - 20px);
    margin: 0 10px 10px;
  }
  .category-panel ul {
    display: flex;
    overflow-x: auto;
    white-space: nowrap;
    padding-bottom: 10px;
    -webkit-overflow-scrolling: touch;
  }
  .category-panel li {
    flex: 0 0 auto;
    margin: 0 5px;
    padding: 8px 15px;
    border-left: none;
    border-bottom: 3px solid transparent;
    border-radius: 6px;
  }
  .category-panel li.active {
    border-left: none;
    border-bottom-color: var(--fo);
  }
  .category-panel li.active::after {
    display: none;
  }
  .player-wrapper {
    order: -1;
    margin-bottom: 15px;
    border-radius: 0;
  }
  .video-js {
    min-height: 220px;
  }
  .channel-list-wrapper {
    padding: 15px;
    height: auto;
    min-height: unset;
  }
  .channel-list {
    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
    gap: 10px;
  }
  .channel-item {
    padding: 10px;
    border-radius: 8px;
  }
  .channel-item img {
    max-width: 60px;
  }
  .resume-prompt {
    font-size: 1.1em;
    padding: 15px;
  }
  .resume-prompt button {
    padding: 10px 20px;
    font-size: 1em;
    margin: 0 8px;
  }
  .loading-screen {
    font-size: 1.3em;
  }
  .loading-spinner {
    width: 45px;
    height: 45px;
    border-width: 5px;
  }
  
  /* Mobil için kontrol paneli ayarları */
  .control-panel {
    bottom: 10px;
    padding: 10px;
  }
  .control-btn {
    width: 50px;
    height: 50px;
    font-size: 20px;
  }
  .center-btn {
    width: 60px;
    height: 60px;
    font-size: 24px;
  }
}
</style>
</head>
<body>
<div class="main-container">
  <div class="content-area" id="contentArea">
    <div class="category-panel">
      <h3>Filmler</h3>
      <input type="text" id="categorySearchInput" placeholder="Kategori içinde ara...">
      <ul id="categoryList"></ul>
    </div>
    <div class="player-list-area">
      <div class="player-wrapper">
        <video id="my-video" class="video-js vjs-default-skin vjs-big-play-centered" controls preload="auto" data-setup='{}'></video>
        <div id="resumePrompt" class="resume-prompt" style="display:none;">
          <p>Kaldığınız yerden devam etmek ister misiniz?</p>
          <div>
            <button id="resumeYes">Evet</button>
            <button id="resumeNo">Baştan Başlat</button>
          </div>
        </div>
      </div>
      <div class="channel-list-wrapper" id="channelListWrapper" tabIndex="0">
        <input type="text" id="channelSearchInput" placeholder="Film içinde ara...">
        <div id="channelList" class="channel-list"></div>
      </div>
    </div>
  </div>
</div>
<div class="loading-screen" id="loadingScreen">
  <div class="loading-spinner"></div>
  <p>İçerik yükleniyor, lütfen bekleyin...</p>
</div>
<div id="errorMessage" class="error-message"></div>

<!-- Yeni Kontrol Paneli -->
<div class="control-panel" id="controlPanel">
  <div class="gamepad-notification" id="gamepadNotification"></div>
  <div class="control-row">
    <div class="control-btn" id="btnVolume" data-key="Ses">🔈</div>
  </div>
  <div class="control-row">
    <div class="control-btn" id="btnBack" data-key="Geri (Esc)">←</div>
    <div class="control-btn center-btn" id="btnPlayPause" data-key="Oynat/Duraklat (⏎)">⏯</div>
    <div class="control-btn" id="btnFullscreen" data-key="Tam Ekran (F)">⛶</div>
  </div>
  <div class="control-row">
    <div class="control-btn" id="btnRewind" data-key="Geri Sar (←)">⏪</div>
    <div class="control-btn" id="btnForward" data-key="İleri Sar (→)">⏩</div>
  </div>
  <div class="volume-control" id="volumeControl">
    <div class="control-btn" id="btnVolUp" data-key="Artır (↑)">🔊</div>
    <div class="control-btn" id="btnVolDown" data-key="Azalt (↓)">🔉</div>
  </div>
</div>

<script src="https://vjs.zencdn.net/8.12.0/video.min.js"></script>
<script src="https://unpkg.com/@videojs/http-streaming/dist/videojs-http-streaming.min.js"></script>
<script>
// Hata ayıklama modu
const DEBUG_MODE = true;
const FALLBACK_M3U_URL = "https://raw.githubusercontent.com/ademolalookman/ademola/refs/heads/main/filmfun.m3u";

// Yardımcı fonksiyonlar
const debounce = (func, delay) => {
    let timeout;
    return function(...args) {
        const context = this;
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(context, args), delay);
    };
};

const showError = (message, type = 'error') => {
    const errorElement = document.getElementById('errorMessage');
    errorElement.textContent = message;
    errorElement.className = `error-message show ${type}`;
    setTimeout(() => errorElement.classList.remove('show'), 5000);
    if (DEBUG_MODE) console.error(message);
};

// M3U Ayrıştırıcı (Daha güçlü versiyon)
const parseM3U = (m3uText) => {
    const lines = m3uText.split('\n');
    const channels = [];
    let currentChannel = {};
    
    for (const line of lines) {
        if (line.startsWith('#EXTINF:')) {
            const tvgIdMatch = line.match(/tvg-id="([^"]*)"/);
            const tvgNameMatch = line.match(/tvg-name="([^"]*)"/);
            const tvgLogoMatch = line.match(/tvg-logo="([^"]*)"/);
            const groupTitleMatch = line.match(/group-title="([^"]*)"/);
            const channelNameMatch = line.match(/,(.*)$/);
            
            currentChannel = {
                id: tvgIdMatch ? tvgIdMatch[1] : '',
                name: tvgNameMatch ? tvgNameMatch[1].trim() : 
                     (channelNameMatch ? channelNameMatch[1].trim() : 'Bilinmeyen Kanal'),
                logo: tvgLogoMatch ? tvgLogoMatch[1] : '',
                category: groupTitleMatch ? groupTitleMatch[1].trim() : 'Diğer',
                url: ''
            };
        } 
        else if (line.startsWith('http') || line.startsWith('rtmp') || line.startsWith('rtsp')) {
            if (currentChannel.name) {
                currentChannel.url = line.trim();
                channels.push(currentChannel);
                currentChannel = {};
            }
        }
    }
    
    if (DEBUG_MODE) {
        console.log("Ayrıştırılan kanal sayısı:", channels.length);
        if (channels.length > 0) {
            console.log("İlk 5 kanal:", channels.slice(0, 5));
        }
    }
    
    return channels;
};

// DOM Elementleri
const categoryList = document.getElementById('categoryList');
const channelList = document.getElementById('channelList');
const channelSearchInput = document.getElementById('channelSearchInput');
const resumePrompt = document.getElementById('resumePrompt');
const resumeYesBtn = document.getElementById('resumeYes');
const resumeNoBtn = document.getElementById('resumeNo');
const loadingScreen = document.getElementById('loadingScreen');
const categorySearchInput = document.getElementById('categorySearchInput');

// Global Değişkenler
let allChannels = [];
let player;
let currentPlaying = null;
let filteredChannels = [];
let filteredCategories = [];
let currentFocus = { group: 'category', index: 0 };

// M3U Yükleme Fonksiyonu (Güçlendirilmiş)
const loadM3ULink = async (url) => {
    loadingScreen.classList.remove('hidden');
    
    try {
        // Önce CORS proxy ile dene
        const corsProxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`;
        let response = await fetch(corsProxyUrl);
        
        let m3uContent;
        if (response.ok) {
            const data = await response.json();
            m3uContent = data.contents;
            if (DEBUG_MODE) console.log("CORS proxy üzerinden içerik alındı");
        } else {
            // Direkt erişim dene
            if (DEBUG_MODE) console.log("CORS proxy başarısız, direkt erişim deneniyor");
            response = await fetch(url);
            if (!response.ok) throw new Error(`HTTP Hatası! Durum: ${response.status}`);
            m3uContent = await response.text();
        }
        
        if (!m3uContent || m3uContent.trim() === '') {
            throw new Error("M3U dosyası boş");
        }
        
        allChannels = parseM3U(m3uContent);
        
        if (allChannels.length === 0) {
            throw new Error("M3U dosyasında kanal bulunamadı");
        }
        
        renderCategories();
        filterChannels(categoryList.querySelector('li.active')?.textContent || 'Tümü');
    } catch (error) {
        console.error('M3U Yükleme Hatası:', error);
        
        // Fallback M3U dene
        if (url !== FALLBACK_M3U_URL) {
            showError(`Ana kaynak yüklenemedi, yedek kaynak deneniyor... (${error.message})`, 'warning');
            await loadM3ULink(FALLBACK_M3U_URL);
            return;
        }
        
        showError(`İçerik yüklenirken hata: ${error.message}`, 'error');
        
        // Test verileriyle devam et
        allChannels = [
            {
                id: 'test1',
                name: 'Test Kanal 1',
                logo: 'https://via.placeholder.com/100',
                category: 'Test',
                url: 'https://test-streams.mux.dev/x36xhzz/x36xhzz.m3u8'
            },
            {
                id: 'test2',
                name: 'Test Kanal 2',
                logo: 'https://via.placeholder.com/100',
                category: 'Test',
                url: 'https://test-streams.mux.dev/x36xhzz/x36xhzz.m3u8'
            }
        ];
        
        renderCategories();
        filterChannels('Tümü');
    } finally {
        loadingScreen.classList.add('hidden');
        updateFocus();
    }
};

// Kategorileri Render Et
const renderCategories = (searchTerm = '') => {
    let categories = ['Tümü', ...new Set(allChannels.map(ch => ch.category))];
    
    if (searchTerm) {
        categories = categories.filter(cat => 
            cat.toLowerCase().includes(searchTerm.toLowerCase())
        );
    }
    
    categories.sort((a, b) => {
        if (a === 'Tümü') return -1;
        if (b === 'Tümü') return 1;
        return a.localeCompare(b);
    });
    
    filteredCategories = categories;
    
    const fragment = document.createDocumentFragment();
    
    categories.forEach((category, index) => {
        const li = document.createElement('li');
        li.textContent = category;
        li.dataset.index = index;
        
        li.addEventListener('click', () => {
            setActiveCategory(li);
            filterChannels(category);
            currentFocus = { group: 'channel', index: 0 };
            updateFocus();
        });
        
        fragment.appendChild(li);
    });
    
    categoryList.innerHTML = '';
    categoryList.appendChild(fragment);
    
    // Varsayılan olarak ilk kategoriyi seç
    if (categories.length > 0 && !categoryList.querySelector('li.active')) {
        setActiveCategory(categoryList.querySelector('li'));
    }
};

// Aktif kategoriyi ayarla
const setActiveCategory = (element) => {
    categoryList.querySelectorAll('li').forEach(li => 
        li.classList.remove('active')
    );
    if (element) element.classList.add('active');
};

// Kanalları Filtrele
const filterChannels = (category, searchTerm = '') => {
    const fragment = document.createDocumentFragment();
    
    filteredChannels = allChannels.filter(channel => 
        (category === 'Tümü' || channel.category === category) &&
        (channel.name.toLowerCase().includes(searchTerm.toLowerCase())
    );
    
    if (filteredChannels.length === 0) {
        channelList.innerHTML = `
            <p style="text-align:center;color:#ccc;padding:20px;">
                Bu kategoride film bulunamadı.
            </p>
        `;
        return;
    }
    
    filteredChannels.forEach((channel, index) => {
        const channelElement = document.createElement('div');
        channelElement.className = 'channel-item';
        channelElement.dataset.index = index;
        
        channelElement.innerHTML = `
            ${channel.logo ? `
                <img src="${channel.logo}" 
                     alt="${channel.name} Logo" 
                     loading="lazy"
                     onerror="this.src='https://via.placeholder.com/100'">
            ` : ''}
            <div class="channel-name" title="${channel.name}">
                ${channel.name}
            </div>
        `;
        
        channelElement.addEventListener('click', () => playChannel(channel));
        
        fragment.appendChild(channelElement);
    });
    
    channelList.innerHTML = '';
    channelList.appendChild(fragment);
};

// Kanal Oynat
const playChannel = (channel) => {
    if (!channel || !channel.url) {
        showError('Geçersiz kanal bilgisi veya URL.', 'error');
        return;
    }
    
    currentPlaying = channel;
    loadingScreen.classList.remove('hidden');
    
    // Önceki olay dinleyicilerini temizle
    player.off('loadedmetadata');
    player.off('error');
    player.off('timeupdate');
    player.off('ended');
    
    // Yeni kaynağı ayarla
    player.src({
        src: channel.url,
        type: 'application/x-mpegURL'
    });
    
    player.poster(channel.logo || '');
    player.load();
    
    // Olay dinleyicileri
    player.on('loadedmetadata', () => {
        loadingScreen.classList.add('hidden');
        
        const storageKey = 'm3u_player_last_position_' + btoa(channel.url);
        const lastPosition = parseFloat(localStorage.getItem(storageKey));
        
        if (player.duration() === Infinity || isNaN(player.duration())) {
            // Canlı yayın
            player.play();
            resumePrompt.style.display = 'none';
            currentFocus = { group: 'player', index: 0 };
        } 
        else if (lastPosition && lastPosition > 5 && (player.duration() - lastPosition) > 10) {
            // Devam etme istemi göster
            resumePrompt.style.display = 'flex';
            currentFocus = { group: 'resumePrompt', index: 0 };
            
            resumeYesBtn.onclick = () => {
                player.currentTime(lastPosition);
                resumePrompt.style.display = 'none';
                player.play();
                currentFocus = { group: 'player', index: 0 };
                updateFocus();
            };
            
            resumeNoBtn.onclick = () => {
                player.currentTime(0);
                resumePrompt.style.display = 'none';
                player.play();
                currentFocus = { group: 'player', index: 0 };
                updateFocus();
            };
        } 
        else {
            // Baştan başlat
            player.currentTime(0);
            resumePrompt.style.display = 'none';
            player.play();
            currentFocus = { group: 'player', index: 0 };
        }
        
        updateFocus();
    });
    
    player.on('error', () => {
        loadingScreen.classList.add('hidden');
        const error = player.error();
        
        let errorMessage = 'Video yüklenirken bilinmeyen bir hata oluştu.';
        if (error) {
            errorMessage = `Video Hatası (${error.code}): ${error.message}`;
            console.error('Video oynatma hatası:', error);
        }
        
        showError(errorMessage + ' Lütfen farklı bir film deneyin.', 'error');
        currentFocus = { group: 'channel', index: 0 };
        updateFocus();
    });
    
    player.on('timeupdate', () => {
        if (currentPlaying && !player.seeking() && !player.paused() && 
            player.duration() !== Infinity && !isNaN(player.duration())) {
            const storageKey = 'm3u_player_last_position_' + btoa(currentPlaying.url);
            localStorage.setItem(storageKey, player.currentTime().toString());
        }
    });
    
    player.on('ended', () => {
        if (currentPlaying) {
            const storageKey = 'm3u_player_last_position_' + btoa(currentPlaying.url);
            localStorage.removeItem(storageKey);
        }
    });
    
    player.focus();
};

// Odak Güncelleme
const updateFocus = () => {
    // Önceki odaklı öğeleri temizle
    document.querySelectorAll('.focused').forEach(el => 
        el.classList.remove('focused')
    );
    
    // Devam istemi gösteriliyorsa
    if (resumePrompt.style.display === 'flex') {
        const buttons = [resumeYesBtn, resumeNoBtn];
        const focusedButton = buttons[currentFocus.index];
        
        if (focusedButton) {
            focusedButton.classList.add('focused');
            focusedButton.focus();
        }
        return;
    }
    
    // Arama inputlarında odak varsa
    const activeElement = document.activeElement;
    if (activeElement === categorySearchInput || activeElement === channelSearchInput) {
        return;
    }
    
    // Yeni odaklı öğeyi ayarla
    let focusedElement = null;
    
    switch (currentFocus.group) {
        case 'category':
            focusedElement = categoryList.children[currentFocus.index];
            break;
        case 'channel':
            focusedElement = channelList.children[currentFocus.index];
            break;
        case 'player':
            player.focus();
            return;
    }
    
    if (focusedElement) {
        focusedElement.classList.add('focused');
        focusedElement.scrollIntoView({
            block: 'nearest',
            behavior: 'smooth'
        });
    }
};

// Kontrolleri Kur
const setupControls = () => {
    const btnPlayPause = document.getElementById('btnPlayPause');
    const btnFullscreen = document.getElementById('btnFullscreen');
    const btnBack = document.getElementById('btnBack');
    const btnRewind = document.getElementById('btnRewind');
    const btnForward = document.getElementById('btnForward');
    const btnVolume = document.getElementById('btnVolume');
    const btnVolUp = document.getElementById('btnVolUp');
    const btnVolDown = document.getElementById('btnVolDown');
    const volumeControl = document.getElementById('volumeControl');
    
    // Oynat/Duraklat
    btnPlayPause.addEventListener('click', () => {
        if (player) {
            if (player.paused()) {
                player.play();
                btnPlayPause.textContent = '⏸';
            } else {
                player.pause();
                btnPlayPause.textContent = '▶';
            }
            btnPlayPause.classList.add('active');
            setTimeout(() => btnPlayPause.classList.remove('active'), 200);
        }
    });
    
    // Tam ekran
    btnFullscreen.addEventListener('click', () => {
        if (player) {
            if (player.isFullscreen()) {
                player.exitFullscreen();
            } else {
                player.requestFullscreen();
            }
            btnFullscreen.classList.add('active');
            setTimeout(() => btnFullscreen.classList.remove('active'), 200);
        }
    });
    
    // Geri butonu
    btnBack.addEventListener('click', () => {
        if (currentFocus.group === 'player' || currentFocus.group === 'channel') {
            currentFocus.group = 'category';
            const activeCategory = categoryList.querySelector('li.active');
            currentFocus.index = activeCategory ? 
                filteredCategories.indexOf(activeCategory.textContent) : 0;
            updateFocus();
            btnBack.classList.add('active');
            setTimeout(() => btnBack.classList.remove('active'), 200);
        }
    });
    
    // Geri sar
    btnRewind.addEventListener('click', () => {
        if (player) {
            player.currentTime(Math.max(0, player.currentTime() - 10));
            btnRewind.classList.add('active');
            setTimeout(() => btnRewind.classList.remove('active'), 200);
        }
    });
    
    // İleri sar
    btnForward.addEventListener('click', () => {
        if (player) {
            player.currentTime(Math.min(player.duration(), player.currentTime() + 10));
            btnForward.classList.add('active');
            setTimeout(() => btnForward.classList.remove('active'), 200);
        }
    });
    
    // Ses kontrolü
    btnVolume.addEventListener('click', () => {
        volumeControl.style.display = volumeControl.style.display === 'block' ? 'none' : 'block';
    });
    
    btnVolUp.addEventListener('click', () => {
        if (player) {
            player.volume(Math.min(1, player.volume() + 0.1));
            btnVolUp.classList.add('active');
            setTimeout(() => btnVolUp.classList.remove('active'), 200);
        }
    });
    
    btnVolDown.addEventListener('click', () => {
        if (player) {
            player.volume(Math.max(0, player.volume() - 0.1));
            btnVolDown.classList.add('active');
            setTimeout(() => btnVolDown.classList.remove('active'), 200);
        }
    });
    
    // Oyun kumandası desteği
    let gamepadConnected = false;
    const gamepadNotification = document.getElementById('gamepadNotification');
    
    function handleGamepad(event, connecting) {
        const gamepad = event.gamepad;
        
        if (connecting) {
            gamepadConnected = true;
            gamepadNotification.textContent = `Oyun kumandası bağlandı: ${gamepad.id}`;
            gamepadNotification.classList.add('show');
            setTimeout(() => gamepadNotification.classList.remove('show'), 3000);
        } else {
            gamepadConnected = false;
            gamepadNotification.textContent = 'Oyun kumandası bağlantısı kesildi';
            gamepadNotification.classList.add('show');
            setTimeout(() => gamepadNotification.classList.remove('show'), 3000);
        }
    }
    
    window.addEventListener("gamepadconnected", (e) => handleGamepad(e, true));
    window.addEventListener("gamepaddisconnected", (e) => handleGamepad(e, false));
    
    function updateGamepad() {
        if (!gamepadConnected) return;
        
        const gamepads = navigator.getGamepads();
        if (!gamepads) return;
        
        const gp = gamepads[0];
        if (!gp) return;
        
        // Buton kontrolleri
        if (gp.buttons[0].pressed) { // A butonu
            if (player) player.paused() ? player.play() : player.pause();
        }
        if (gp.buttons[1].pressed) { // B butonu
            if (currentFocus.group === 'player' || currentFocus.group === 'channel') {
                currentFocus.group = 'category';
                const activeCategory = categoryList.querySelector('li.active');
                currentFocus.index = activeCategory ? 
                    filteredCategories.indexOf(activeCategory.textContent) : 0;
                updateFocus();
            }
        }
        if (gp.buttons[6].pressed) { // LB
            if (player) player.currentTime(Math.max(0, player.currentTime() - 10));
        }
        if (gp.buttons[7].pressed) { // RB
            if (player) player.currentTime(Math.min(player.duration(), player.currentTime() + 10));
        }
        
        // D-pad kontrolleri
        if (gp.axes[1] < -0.5) { // Yukarı
            if (player) player.volume(Math.min(1, player.volume() + 0.05));
        }
        if (gp.axes[1] > 0.5) { // Aşağı
            if (player) player.volume(Math.max(0, player.volume() - 0.05));
        }
        
        requestAnimationFrame(updateGamepad);
    }
    
    // Oyun kumandası kontrol döngüsünü başlat
    if (navigator.getGamepads) {
        setInterval(() => {
            if (gamepadConnected) {
                updateGamepad();
            }
        }, 100);
    }
};

// Klavye Kontrolleri
const handleKeyDown = (e) => {
    const activeElement = document.activeElement;
    const isPlayerActive = !player.paused() || player.userActive() || player.isFullscreen();
    const isResumePromptVisible = resumePrompt.style.display === 'flex';
    const isSearchInputFocused = activeElement === categorySearchInput || 
                                activeElement === channelSearchInput;
    
    // Arama inputlarında
    if (isSearchInputFocused) {
        if (e.key === 'Escape') {
            e.preventDefault();
            activeElement.blur();
        }
        return;
    }
    
    // Devam istemi gösteriliyorsa
    if (isResumePromptVisible) {
        e.preventDefault();
        
        const buttons = [resumeYesBtn, resumeNoBtn];
        
        switch (e.key) {
            case 'ArrowLeft':
                currentFocus.index = 0;
                break;
            case 'ArrowRight':
                currentFocus.index = 1;
                break;
            case 'Enter':
                buttons[currentFocus.index]?.click();
                break;
            case 'Escape':
                resumeNoBtn.click();
                break;
        }
        
        updateFocus();
        return;
    }
    
    // Oyuncu aktifse
    if (isPlayerActive) {
        const playerControls = [' ', 'Enter', 'MediaPlayPause', 'ArrowLeft', 
                              'ArrowRight', 'ArrowUp', 'ArrowDown', 'Escape'];
        
        if (playerControls.includes(e.key)) {
            e.preventDefault();
            
            switch (e.key) {
                case ' ':
                case 'Enter':
                case 'MediaPlayPause':
                    player.paused() ? player.play() : player.pause();
                    break;
                case 'ArrowLeft':
                    player.currentTime(player.currentTime() - 10);
                    break;
                case 'ArrowRight':
                    player.currentTime(player.currentTime() + 10);
                    break;
                case 'ArrowUp':
                    player.volume(Math.min(1, player.volume() + 0.1));
                    break;
                case 'ArrowDown':
                    player.volume(Math.max(0, player.volume() - 0.1));
                    break;
                case 'Escape':
                    if (player.isFullscreen()) {
                        player.exitFullscreen();
                    } else {
                        player.pause();
                        currentFocus = { group: 'channel', index: 0 };
                        updateFocus();
                    }
                    break;
            }
        }
        return;
    }
    
    // Genel kontroller
    e.preventDefault();
    
    const getColumnsPerRow = () => {
        const gridStyle = getComputedStyle(channelList).gridTemplateColumns;
        return gridStyle.split(' ').length;
    };
    
    switch (e.key) {
        case 'ArrowUp':
            if (currentFocus.group === 'category') {
                currentFocus.index = Math.max(0, currentFocus.index - 1);
            } else if (currentFocus.group === 'channel') {
                currentFocus.index = Math.max(0, currentFocus.index - getColumnsPerRow());
            }
            break;
            
        case 'ArrowDown':
            if (currentFocus.group === 'category') {
                currentFocus.index = Math.min(filteredCategories.length - 1, currentFocus.index + 1);
            } else if (currentFocus.group === 'channel') {
                currentFocus.index = Math.min(filteredChannels.length - 1, currentFocus.index + getColumnsPerRow());
            }
            break;
            
        case 'ArrowLeft':
            if (currentFocus.group === 'channel' && currentFocus.index % getColumnsPerRow() === 0) {
                currentFocus.group = 'category';
                const activeCategory = categoryList.querySelector('li.active');
                currentFocus.index = activeCategory ? 
                    filteredCategories.indexOf(activeCategory.textContent) : 0;
            } else if (currentFocus.group === 'channel') {
                currentFocus.index -= 1;
            }
            break;
            
        case 'ArrowRight':
            if (currentFocus.group === 'category') {
                currentFocus.group = 'channel';
                currentFocus.index = 0;
            } else if (currentFocus.group === 'channel' && currentFocus.index < filteredChannels.length - 1) {
                currentFocus.index += 1;
            }
            break;
            
        case 'Enter':
            let elementToClick;
            if (currentFocus.group === 'category') {
                elementToClick = categoryList.children[currentFocus.index];
            } else {
                elementToClick = channelList.children[currentFocus.index];
            }
            elementToClick?.click();
            break;
            
        case 'Escape':
            if (currentFocus.group === 'channel') {
                currentFocus.group = 'category';
                const activeCategory = categoryList.querySelector('li.active');
                currentFocus.index = activeCategory ? 
                    filteredCategories.indexOf(activeCategory.textContent) : 0;
            }
            break;
    }
    
    updateFocus();
};

// Sayfa Yüklendiğinde
document.addEventListener('DOMContentLoaded', () => {
    // VideoJS oynatıcıyı başlat
    player = videojs('my-video', {
        fluid: true,
        autoplay: false,
        controls: true,
        techCanOverrideControls: true,
        controlBar: {
            children: [
                'playToggle',
                'volumePanel',
                'currentTimeDisplay',
                'durationDisplay',
                'progressControl',
                'liveDisplay',
                'customControlSpacer',
                'playbackRateMenuButton',
                'chaptersButton',
                'descriptionsButton',
                'subsCapsButton',
                'audioTrackButton',
                'fullscreenToggle'
            ]
        }
    });
    
    // Kontrolleri kur
    setupControls();
    
    // M3U dosyasını yükle
    loadM3ULink(FALLBACK_M3U_URL);
    
    // Arama inputları için dinleyiciler
    categorySearchInput.addEventListener('input', debounce(() => {
        renderCategories(categorySearchInput.value.trim());
    }, 300));
    
    channelSearchInput.addEventListener('input', debounce(() => {
        const activeCategory = categoryList.querySelector('li.active');
        const category = activeCategory ? activeCategory.textContent : 'Tümü';
        filterChannels(category, channelSearchInput.value.trim());
    }, 300));
    
    // Klavye dinleyicisi
    document.addEventListener('keydown', handleKeyDown);
});

// Hata yönetimi
window.addEventListener('error', (event) => {
    showError(`JavaScript Hatası: ${event.message}`, 'error');
    if (DEBUG_MODE) console.error(event.error);
});
</script>
</body>
</html>